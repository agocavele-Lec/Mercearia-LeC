<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="utf-8" />
<title>Mercearia Gestão – Final com Leitor QR, Export, Pesquisa POS</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="theme-color" content="#2e7d32" />
<link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIk1lcmNlYXJpYSIsCiAgInNob3J0X25hbWUiOiAiTWVyY2VhcmlhIiwKICAic3RhcnRfdXJsIjogIi8iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiNmZmYiLAogICJ0aGVtZV9jb2xvciI6ICAiIzJlN2QzMiIsCiAgImljb25zIjogW3sic3JjIjoiaWNvbi0xOTIucG5nIiwic2l6ZXMiOiIxOTJ4MTkyIiwidHlwZSI6ImltYWdlL3BuZyJ9XQp9" />
<!-- Bibliotecas OFF-LINE -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<style>
  body{font-family:Arial,Helvetica,sans-serif;margin:0;background:#f4f4f4}
  header{background:#2e7d32;color:#fff;padding:.6rem 1rem;font-size:1.2rem;font-weight:700}
  nav{display:flex;gap:.5rem;background:#388e3c;padding:.4rem 1rem;flex-wrap:wrap}
  nav button{padding:.4rem .8rem;border:none;background:#fff;color:#2e7d32;border-radius:4px;cursor:pointer}
  .page{display:none;padding:1rem}
  .page.active{display:block}
  table{width:100%;border-collapse:collapse;margin-top:.5rem;background:#fff;font-size:.9rem}
  th,td{padding:.4rem;border:1px solid #ccc;text-align:left}
  th{background:#e8f5e9}
  input,select{padding:.4rem;width:100%;box-sizing:border-box}
  .row{display:flex;gap:.5rem;margin:.5rem 0;flex-wrap:wrap}
  .row>div{flex:1;min-width:140px}
  button{padding:.4rem .6px;font-size:.85rem}
  .check-line{display:flex;align-items:center;gap:.3rem}
  .qtd-btns{display:flex;gap:.3rem;margin-top:.3rem;flex-wrap:wrap}
  .qtd-btns button{min-width:42px}
  .troco-box{background:#e8f5e9;padding:.5rem;border-radius:4px;margin-top:.5rem}
  .avulso-line{display:flex;align-items:center;gap:.3rem;margin-top:.3rem}
  .danger-btn{background:#d32f2f;color:#fff;border:none;padding:.5rem .8rem;border-radius:4px;cursor:pointer;margin-top:1rem}
  .resumo-box{background:#e8f5e9;padding:.5rem;border-radius:4px;margin-top:.5rem}
  #reader{width:100%;max-width:400px;margin:auto}
  .pesquisa-pos{background:#fff;padding:.5rem;border-radius:4px;margin-bottom:.5rem}
  @media print{nav,header,button{display:none}}
</style>
</head>
<body>
<header>Mercearia Gestão – Final Completo</header>
<nav>
  <button onclick="show('venda')">Ponto de Venda</button>
  <button onclick="show('prod')">Produtos</button>
  <button onclick="show('cat')">Categorias</button>
  <button onclick="show('rel')">Relatório</button>
</nav>

<!-- PONTO DE VENDA -->
<section id="venda" class="page active">
  <h3>Nova Venda</h3>
  <!-- PESQUISA RÁPIDA -->
  <div class="pesquisa-pos">
    <input id="pesquisaPOS" placeholder="Pesquisar produto..." oninput="filtraPOS()"/>
  </div>
  <div class="row">
    <div>
      <label>Produto</label>
      <select id="venda_prod" onchange="toggleAvulso()"></select>
    </div>
    <div id="div_qtd">
      <label id="lbl_qtd">Quantidade (un)</label>
      <input id="venda_qtd" type="number" step="0.001" min="0.001" value="1"/>
      <div class="qtd-btns">
        <button onclick="addQtd(1)">+1</button>
        <button onclick="addQtd(5)">+5</button>
        <button onclick="addQtd(10)">+10</button>
        <button onclick="addQtd(0.5)">+0,5 kg</button>
        <button onclick="setQtd(0)">Zerar</button>
      </div>
    </div>
    <div id="div_avulso" style="display:none">
      <label>Valor avulso (Mts)</label>
      <input id="valor_avulso" type="number" step="0.01" placeholder="0.00"/>
    </div>
    <div style="display:flex;align-items:flex-end">
      <button onclick="addCarrinho()">Adicionar</button>
    </div>
  </div>
  <!-- LEITOR QR -->
  <div id="reader" style="display:none"></div>
  <button onclick="iniciarLeitor()">Ler Código QR/Barras</button>
  <button onclick="pararLeitor()">Parar Leitor</button>

  <table id="carrinho">
    <thead><tr><th>Produto</th><th>Qtd</th><th>Preço UN (Mts)</th><th>Total (Mts)</th><th>Lucro (Mts)</th><th>-</th></tr></thead>
    <tbody></tbody>
  </table>

  <h4>Total Venda: <span id="totalvenda">0.00</span> Mts | Lucro Venda: <span id="totallucro">0.00</span> Mts</h4>

  <div class="troco-box">
    <div class="row">
      <div>
        <label>Valor dado (Mts)</label>
        <input id="valor_dado" type="number" step="0.01" placeholder="0.00" oninput="calcTroco()"/>
      </div>
      <div>
        <label>Troco (Mts)</label>
        <input id="troco" type="text" readonly value="0.00"/>
      </div>
    </div>
  </div>

  <button onclick="finalizarVenda()">Finalizar Venda</button>
</section>

<!-- PRODUTOS -->
<section id="prod" class="page">
  <h3>Gerenciar Produtos</h3>
  <div class="row">
    <div><input id="prod_nome" placeholder="Nome do produto"/></div>
    <div>
      <label>Categoria</label>
      <select id="prod_cat"></select>
    </div>
  </div>
  <div class="row">
    <div><input id="prod_preco_compra" type="number" step="0.01" placeholder="Preço de compra (Mts)"/></div>
    <div><input id="prod_preco" type="number" step="0.01" placeholder="Preço de venda (Mts)"/></div>
    <div><input id="prod_stock" type="number" step="0.001" placeholder="Stock (un ou kg)"/></div>
    <div><input id="prod_codigo" placeholder="Código de barras (opcional)"/></div>
    <div class="check-line">
      <input type="checkbox" id="prod_peso"/>
      <label for="prod_peso">Vende por peso (kg)</label>
    </div>
  </div>
  <button onclick="saveProd()">Salvar Produto</button>
  <table id="table_prod">
    <thead><tr><th>Nome</th><th>Categoria</th><th>Custo (Mts)</th><th>Venda (Mts)</th><th>Stock</th><th>Und</th><th>Ações</th></tr></thead>
    <tbody></tbody>
  </table>
  <hr>
  <button onclick="exportarDados()">Exportar Dados (Excel/CSV)</button>
  <input type="file" id="importFile" accept=".json,.csv" onchange="importarDados()" style="margin-left:.5rem"/>
</section>

<!-- CATEGORIAS -->
<section id="cat" class="page">
  <h3>Gerenciar Categorias</h3>
  <div class="row">
    <div><input id="cat_nome" placeholder="Nome da categoria"/></div>
    <div><button onclick="saveCat()">Salvar</button></div>
  </div>
  <table id="table_cat">
    <thead><tr><th>Categoria</th><th>-</th></tr></thead>
    <tbody></tbody>
  </table>
</section>

<!-- RELATÓRIO -->
<section id="rel" class="page">
  <h3>Resumo por Período</h3>
  <div class="resumo-box">
    <button onclick="gerarResumo(7)">Últimos 7 dias</button>
    <button onclick="gerarResumo(30)">Últimos 30 dias</button>
    <button onclick="listarDiario()">Diário (todos os dias)</button>
  </div>
  <div id="resumo_periodo"></div>

  <h3>Produtos + Vendidos e Parados</h3>
  <button onclick="rankProdutos()">Gerar Rank</button>
  <div id="rank_area"></div>

  <h3>Relatório Diário Detalhado</h3>
  <div id="diario_det"></div>

  <h3>Produtos Vendidos (Detalhe Geral)</h3>
  <table id="table_det">
    <thead><tr><th>Produto</th><th>Qtd Total</th><th>Total Vendido (Mts)</th><th>Lucro (Mts)</th></tr></thead>
    <tbody></tbody>
  </table>

  <button class="danger-btn" onclick="apagarHist()">Apagar / Inicializar Histórico de Vendas</button>
</section>

<script src="https://unpkg.com/dexie@3.2.4/dist/dexie.min.js"></script>
<script>
/* ---------- BANCO ---------- */
const db = new Dexie('MerceariaDB');
db.version(8).stores({
  categorias: '++id, nome',
  produtos: '++id, nome, categoriaId, precoCompra, preco, stock, porPeso, codigoBarras',
  vendas: '++id, total, custoTotal, data',
  itensVenda: '++id, vendaId, produtoId, qtd, precoUnit, custoUnit'
});

/* ---------- NAVEGAÇÃO ---------- */
function show(p){
  document.querySelectorAll('.page').forEach(x=>x.classList.remove('active'));
  document.getElementById(p).classList.add('active');
  if(p==='venda') { loadSelects(); }
  if(p==='prod') { loadCats(); listProd(); }
  if(p==='cat') listCat();
  if(p==='rel') { listDet(); }
}

/* ---------- CATEGORIAS ---------- */
async function saveCat(){
  const nome = document.getElementById('cat_nome').value.trim();
  if(!nome) return alert('Nome obrigatório');
  await db.categorias.add({nome});
  document.getElementById('cat_nome').value='';
  listCat();
}
async function listCat(){
  const list = await db.categorias.toArray();
  const tbody = document.querySelector('#table_cat tbody');
  tbody.innerHTML = list.map(c=>`<tr><td>${c.nome}</td><td><button onclick="delCat(${c.id})">X</button></td></tr>`).join('');
}
async function delCat(id){
  await db.categorias.delete(id);
  listCat();
}
async function loadCats(){
  const cats = await db.categorias.toArray();
  const sel = document.getElementById('prod_cat');
  sel.innerHTML = cats.map(c=>`<option value="${c.id}">${c.nome}</option>`).join('');
}

/* ---------- PRODUTOS ---------- */
let editingId = null;
async function saveProd(){
  const nome = document.getElementById('prod_nome').value.trim();
  const categoriaId = parseInt(document.getElementById('prod_cat').value)||0;
  const precoCompra = parseFloat(document.getElementById('prod_preco_compra').value)||0;
  const preco = parseFloat(document.getElementById('prod_preco').value)||0;
  const stock = parseFloat(document.getElementById('prod_stock').value)||0;
  const codigoBarras = (document.getElementById('prod_codigo').value || '').trim();
  const porPeso = document.getElementById('prod_peso').checked;
  if(!nome) return alert('Nome obrigatório');
  
  if(codigoBarras){
    const existe = await db.produtos.where('codigoBarras').equals(codigoBarras).first();
    if(existe && (!editingId || existe.id !== editingId)) {
      return alert('Código de barras já cadastrado em outro produto!');
    }
  }

  if(editingId){
    await db.produtos.update(editingId, {nome, categoriaId, precoCompra, preco, stock, porPeso, codigoBarras});
    editingId = null;
  } else {
    await db.produtos.add({nome, categoriaId, precoCompra, preco, stock, porPeso, codigoBarras});
  }
  ['prod_nome','prod_preco_compra','prod_preco','prod_stock','prod_codigo'].forEach(x=>document.getElementById(x).value='');
  document.getElementById('prod_peso').checked=false;
  listProd();
}
async function listProd(){
  const list = await db.produtos.orderBy('nome').toArray();
  const cats = await db.categorias.toArray(); const catMap = {};
  cats.forEach(c=>catMap[c.id]=c.nome);
  const tbody = document.querySelector('#table_prod tbody');
  tbody.innerHTML = list.map(p=>{
    const und = p.porPeso ? 'kg' : 'un';
    return `<tr>
      <td>${p.nome}${p.codigoBarras ? ' (' + p.codigoBarras + ')' : ''}</td>
      <td>${catMap[p.categoriaId]||'—'}</td>
      <td>${p.precoCompra.toFixed(2)}</td>
      <td>${p.preco.toFixed(2)}</td>
      <td>${p.stock.toFixed(3)}</td>
      <td>${und}</td>
      <td>
        <button onclick="editProd(${p.id})">Editar</button>
        <button onclick="delProd(${p.id})">Apagar</button>
        <button onclick="ajustStock(${p.id},1)">+Entrada</button>
        <button onclick="ajustStock(${p.id},-1)">+Saída</button>
      </td>
    </tr>`;
  }).join('');
}
async function editProd(id){
  const p = await db.produtos.get(id);
  document.getElementById('prod_nome').value = p.nome;
  document.getElementById('prod_cat').value = p.categoriaId;
  document.getElementById('prod_preco_compra').value = p.precoCompra;
  document.getElementById('prod_preco').value = p.preco;
  document.getElementById('prod_stock').value = p.stock;
  document.getElementById('prod_codigo').value = p.codigoBarras || '';
  document.getElementById('prod_peso').checked = p.porPeso;
  editingId = id;
}
async function delProd(id){
  if(!confirm('Apagar produto?')) return;
  await db.produtos.delete(id);
  listProd();
}
async function ajustStock(id, sinal){
  const qtd = prompt(sinal>0 ? 'Quantidade a ENTRAR (kg/un):' : 'Quantidade a SAIR (kg/un):');
  if(!qtd) return;
  const q = parseFloat(qtd)||0;
  if(q<=0) return alert('Quantidade inválida');
  const p = await db.produtos.get(id);
  const novo = p.stock + (sinal*q);
  if(novo<0) return alert('Stock não pode ficar negativo');
  await db.produtos.update(id, {stock: novo});
  listProd();
}

/* ---------- VENDA – SEM CONTROLE DE ESTOQUE ---------- */
let carrinho = [];
async function loadSelects(){
  const prod = await db.produtos.orderBy('nome').toArray();
  window._produtosPOS = prod;
  renderSelectPOS(prod);
  ajustaLabelQtd();
  document.getElementById('venda_prod').addEventListener('change',toggleAvulso);
  toggleAvulso();
}
function renderSelectPOS(list){
  document.getElementById('venda_prod').innerHTML = list.map(p=>{
    const und = p.porPeso ? 'kg' : 'un';
    return `<option value="${p.id}">${p.nome} (${und})${p.codigoBarras ? ' [' + p.codigoBarras + ']' : ''}</option>`;
  }).join('');
}
function filtraPOS(){
  const txt = document.getElementById('pesquisaPOS').value.toLowerCase();
  const filtrados = window._produtosPOS.filter(p=>p.nome.toLowerCase().includes(txt));
  renderSelectPOS(filtrados);
}
function ajustaLabelQtd(){
  const id = parseInt(document.getElementById('venda_prod').value);
  db.produtos.get(id).then(p=>{
    if(!p) return;
    document.getElementById('lbl_qtd').textContent = p.porPeso ? 'Quantidade (kg)' : 'Quantidade (un)';
    document.getElementById('venda_qtd').step = p.porPeso ? '0.001' : '1';
  });
}
function toggleAvulso(){
  const id = parseInt(document.getElementById('venda_prod').value);
  if(!id) return;
  db.produtos.get(id).then(p=>{
    const ehKg = p?.porPeso;
    document.getElementById('div_avulso').style.display = ehKg ? 'block' : 'none';
    document.getElementById('div_qtd').style.display = ehKg ? 'none' : 'block';
    if(!ehKg) document.getElementById('valor_avulso').value = '';
  });
}
function addQtd(n){
  const v = parseFloat(document.getElementById('venda_qtd').value)||0;
  document.getElementById('venda_qtd').value = Math.max(0, v + n).toFixed(3);
}
function setQtd(n){
  document.getElementById('venda_qtd').value = n.toFixed(3);
}
function addCarrinho(){
  const id = parseInt(document.getElementById('venda_prod').value);
  const ehKg = document.getElementById('div_avulso').style.display === 'block';
  let qtd = 0;
  if(ehKg){
    const valor = parseFloat(document.getElementById('valor_avulso').value)||0;
    if(valor<=0) return alert('Valor avulso inválido');
    db.produtos.get(id).then(p=>{
      qtd = valor / p.preco;
      if(qtd<=0) return alert('Quantidade calculada inválida');
      _addCarrinhoLogic({produtoId:id, nome:p.nome, qtd, precoUnit:p.preco, custoUnit:p.precoCompra, porPeso:true});
      document.getElementById('valor_avulso').value='';
    });
  } else {
    qtd = parseFloat(document.getElementById('venda_qtd').value)||0;
    if(qtd<=0) return alert('Quantidade inválida');
    db.produtos.get(id).then(p=>{
      _addCarrinhoLogic({produtoId:id, nome:p.nome, qtd, precoUnit:p.preco, custoUnit:p.precoCompra, porPeso:false});
    });
  }
}
function _addCarrinhoLogic(item){
  const existe = carrinho.find(x=>x.produtoId===item.produtoId);
  if(existe){
    existe.qtd += item.qtd;
  } else {
    carrinho.push(item);
  }
  renderCarrinho();
  calcTroco();
}
function delCarrinho(idx){ carrinho.splice(idx,1); renderCarrinho(); calcTroco(); }
function renderCarrinho(){
  const tb = document.querySelector('#carrinho tbody');
  let total = 0, totCusto = 0;
  tb.innerHTML = carrinho.map((it,idx)=>{
    const sub = it.qtd*it.precoUnit;
    const subCusto = it.qtd*it.custoUnit;
    total+=sub; totCusto+=subCusto;
    const und = it.porPeso ? 'kg' : 'un';
    return `<tr>
      <td>${it.nome}</td><td>${it.qtd.toFixed(3)} ${und}</td><td>${it.precoUnit.toFixed(2)}</td>
      <td>${sub.toFixed(2)}</td><td>${(sub-subCusto).toFixed(2)}</td>
      <td><button onclick="delCarrinho(${idx})">X</button></td>
    </tr>`;
  }).join('');
  document.getElementById('totalvenda').textContent = total.toFixed(2);
  document.getElementById('totallucro').textContent = (total-totCusto).toFixed(2);
}
function calcTroco(){
  const total = parseFloat(document.getElementById('totalvenda').textContent)||0;
  const dado = parseFloat(document.getElementById('valor_dado').value)||0;
  document.getElementById('troco').value = Math.max(0, dado - total).toFixed(2);
}
async function finalizarVenda(){
  if(carrinho.length===0) return alert('Carrinho vazio');
  const total = carrinho.reduce((s,it)=>s+it.qtd*it.precoUnit,0);
  const custoTotal = carrinho.reduce((s,it)=>s+it.qtd*it.custoUnit,0);
  const data = new Date();
  const vendaId = await db.vendas.add({total, custoTotal, data});
  for(const it of carrinho){
    await db.itensVenda.add({vendaId, produtoId:it.produtoId, qtd:it.qtd, precoUnit:it.precoUnit, custoUnit:it.custoUnit});
  }
  alert('Venda finalizada!\nTotal: ' + total.toFixed(2) + ' Mts\nLucro: ' + (total-custoTotal).toFixed(2) + ' Mts');
  carrinho=[];
  renderCarrinho();
  document.getElementById('valor_dado').value='';
  calcTroco();
  loadSelects();
}

/* ---------- LEITOR QR / BARRAS ---------- */
let html5Qr;
function iniciarLeitor(){
  document.getElementById('reader').style.display='block';
  html5Qr = new Html5Qrcode("reader");
  html5Qr.start({ facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    async (codigo) => {
      codigo = codigo.trim();
      if(!codigo) return;
      const p = await db.produtos.where('codigoBarras').equals(codigo).first();
      if(!p) return alert('Produto com código "' + codigo + '" não encontrado!');
      document.getElementById('venda_prod').value = p.id;
      toggleAvulso();
      pararLeitor();
    },
    err => {}
  ).catch(err => alert('Erro ao iniciar câmera: ' + (err.message || err)));
}
function pararLeitor(){
  if(html5Qr) {
    html5Qr.stop().then(() => {
      document.getElementById('reader').style.display='none';
    }).catch(() => {});
  }
}

/* ---------- EXPORTAR / IMPORTAR ---------- */
async function exportarDados(){
  const prods = await db.produtos.orderBy('nome').toArray();
  const vendas = await db.vendas.toArray();
  const itens = await db.itensVenda.toArray();
  const cats = await db.categorias.toArray();
  const data = { produtos: prods, vendas: vendas, itensVenda: itens, categorias: cats };
  // Excel
  const ws = XLSX.utils.json_to_sheet(prods);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Produtos');
  XLSX.writeFile(wb, 'mercearia_backup.xlsx');
  // JSON também
  const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'mercearia_backup.json'; a.click();
}
async function importarDados(){
  const file = document.getElementById('importFile').files[0];
  if(!file) return;
  const text = await file.text();
  let data;
  if(file.name.endsWith('.json')){
    data = JSON.parse(text);
  } else {
    const wb = XLSX.read(text, {type: 'binary'});
    const ws = wb.Sheets[wb.SheetNames[0]];
    data = {produtos: XLSX.utils.sheet_to_json(ws)};
  }
  if(data.produtos){
    for(const p of data.produtos){
      await db.produtos.put(p);
    }
    alert('Produtos importados!');
    listProd();
  }
}

/* ---------- RELATÓRIOS + RANK ---------- */
async function listarDiario(){
  const vendas = await db.vendas.orderBy('data').toArray();
  const dias = {};
  for(const v of vendas){
    const dia = new Date(v.data).toISOString().slice(0,10);
    if(!dias[dia]) dias[dia] = {total:0, lucro:0};
    dias[dia].total += v.total;
    dias[dia].lucro += (v.total - v.custoTotal);
  }
  const diarioDiv = document.getElementById('diario_det');
  diarioDiv.innerHTML = '';
  for(const [dia, vals] of Object.entries(dias).sort((a,b)=>a[0].localeCompare(b[0]))){
    diarioDiv.insertAdjacentHTML('beforeend', `
      <div style="margin-top:1rem">
        <strong>${dia}</strong> – Total: ${vals.total.toFixed(2)} Mts – Lucro: ${vals.lucro.toFixed(2)} Mts
        <button onclick="verDetDia('${dia}')">Ver detalhes do dia</button>
      </div>
    `);
  }
}
async function verDetDia(dia){
  const inicio = new Date(dia);
  const fim = new Date(dia); fim.setDate(fim.getDate()+1);
  const vendasDoDia = await db.vendas.where('data').between(inicio, fim).toArray();
  let html = `<h4>Detalhes de ${dia}</h4><table style="width:100%;font-size:.9rem"><thead><tr><th>Hora</th><th>Total (Mts)</th><th>Lucro (Mts)</th><th>-</th></tr></thead><tbody>`;
  for(const v of vendasDoDia){
    html += `<tr>
      <td>${new Date(v.data).toLocaleTimeString('pt-PT')}</td>
      <td>${v.total.toFixed(2)}</td>
      <td>${(v.total - v.custoTotal).toFixed(2)}</td>
      <td><button onclick="verDetVenda(${v.id})">Itens</button></td>
    </tr>`;
  }
  html += '</tbody></table>';
  const win = window.open('', '', 'width=600,height=400');
  win.document.write(html); win.document.close();
}
async function gerarResumo(dias){
  const fim = new Date(); const inicio = new Date(); inicio.setDate(fim.getDate() - dias);
  const vendas = await db.vendas.where('data').between(inicio, fim).toArray();
  let totalV = 0, totalL = 0;
  const porDia = {};
  for(const v of vendas){
    const dia = new Date(v.data).toISOString().slice(0,10);
    if(!porDia[dia]) porDia[dia] = {v:0, l:0};
    porDia[dia].v += v.total;
    porDia[dia].l += (v.total - v.custoTotal);
    totalV += v.total;
    totalL += (v.total - v.custoTotal);
  }
  let html = `<h4>Resumo dos últimos ${dias} dias</h4>
    <div class="resumo-box">
      <strong>Total vendido:</strong> ${totalV.toFixed(2)} Mts<br>
      <strong>Lucro total:</strong> ${totalL.toFixed(2)} Mts
    </div>
    <table style="width:100%;margin-top:.5rem"><thead><tr><th>Dia</th><th>Vendido (Mts)</th><th>Lucro (Mts)</th><th>-</th></tr></thead><tbody>`;
  for(const [dia, vals] of Object.entries(porDia).sort((a,b)=>a[0].localeCompare(b[0]))){
    html += `<tr>
      <td>${dia}</td>
      <td>${vals.v.toFixed(2)}</td>
      <td>${vals.l.toFixed(2)}</td>
      <td><button onclick="verDetDia('${dia}')">Detalhes</button></td>
    </tr>`;
  }
  html += '</tbody></table>';
  document.getElementById('resumo_periodo').innerHTML = html;
}
async function verDetVenda(vendaId){
  const itens = await db.itensVenda.where({vendaId}).toArray();
  const prodMap = {};
  for(const it of itens){
    const p = await db.produtos.get(it.produtoId);
    const nome = p ? p.nome : '—';
    const key = `${nome} (${p?.porPeso ? 'kg' : 'un'})`;
    if(!prodMap[key]) prodMap[key] = {qtd:0, total:0, lucro:0};
    prodMap[key].qtd += it.qtd;
    prodMap[key].total += it.qtd * it.precoUnit;
    prodMap[key].lucro += it.qtd * (it.precoUnit - it.custoUnit);
  }
  let html = '<table style="width:100%;margin-top:.5rem"><thead><tr><th>Produto</th><th>Qtd</th><th>Total (Mts)</th><th>Lucro (Mts)</th></tr></thead><tbody>';
  for(const [nome, v] of Object.entries(prodMap)){
    html += `<tr><td>${nome}</td><td>${v.qtd.toFixed(3)}</td><td>${v.total.toFixed(2)}</td><td>${v.lucro.toFixed(2)}</td></tr>`;
  }
  html += '</tbody></table>';
  const win = window.open('', '', 'width=600,height=400');
  win.document.write('<html><head><title>Detalhe da Venda</title></head><body><h3>Detalhe da Venda</h3>' + html + '</body></html>');
  win.document.close();
}
async function rankProdutos(){
  const itens = await db.itensVenda.toArray();
  const prodVendido = {};
  for(const it of itens){
    const p = await db.produtos.get(it.produtoId);
    if(!p) continue;
    const key = `${p.nome} (${p.porPeso?'kg':'un'})`;
    if(!prodVendido[key]) prodVendido[key] = 0;
    prodVendido[key] += it.qtd;
  }
  const todos = await db.produtos.orderBy('nome').toArray();
  const parados = todos.filter(p=>!prodVendido[`${p.nome} (${p.porPeso?'kg':'un'})`]);
  const maisVendidos = Object.entries(prodVendido).sort((a,b)=>b[1]-a[1]).slice(0,10);
  let html = `<h4>Mais Vendidos</h4><table style="width:100%"><thead><tr><th>Produto</th><th>Qtd Total</th></tr></thead><tbody>`;
  for(const [nome, qtd] of maisVendidos){
    html += `<tr><td>${nome}</td><td>${qtd.toFixed(3)}</td></tr>`;
  }
  html += '</tbody></table>';
  html += `<h4>Produtos Parados (nunca vendidos)</h4><ul>`;
  for(const p of parados){
    html += `<li>${p.nome}</li>`;
  }
  html += '</ul>';
  html += `<br><button onclick="exportarRankPDF()">Exportar PDF</button> <button onclick="exportarRankExcel()">Exportar Excel</button>`;
  document.getElementById('rank_area').innerHTML = html;
  window._rankMV = prodVendido; // para exportação
}
function exportarRankPDF(){
  const { jsPDF } = window.jspdf; const doc = new jsPDF();
  doc.text('Rank Produtos', 10, 10);
  const maisVendidos = Object.entries(window._rankMV||{}).sort((a,b)=>b[1]-a[1]).slice(0,10);
  let y = 20;
  doc.text('Mais Vendidos:', 10, y); y+=10;
  maisVendidos.forEach(([n,q])=>{ doc.text(`${n} – ${q.toFixed(2)}`, 10, y); y+=7; });
  doc.save('rank_produtos.pdf');
}
function exportarRankExcel(){
  const maisVendidos = Object.entries(window._rankMV||{}).sort((a,b)=>b[1]-a[1]).slice(0,10);
  const ws = XLSX.utils.json_to_sheet(maisVendidos.map(([n,q])=>({Produto:n,Qtd:q})));
  const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Rank');
  XLSX.writeFile(wb, 'rank_produtos.xlsx');
}
async function listDet(){
  const itens = await db.itensVenda.toArray();
  const prodMap = {};
  for(const it of itens){
    const p = await db.produtos.get(it.produtoId);
    const nome = p ? p.nome : '—';
    const key = `${nome} (${p?.porPeso ? 'kg' : 'un'})`;
    if(!prodMap[key]) prodMap[key] = {qtd:0, total:0, lucro:0};
    prodMap[key].qtd += it.qtd;
    prodMap[key].total += it.qtd * it.precoUnit;
    prodMap[key].lucro += it.qtd * (it.precoUnit - it.custoUnit);
  }
  window._rankMV = prodMap;
  const sorted = Object.entries(prodMap).sort((a,b)=>a[0].localeCompare(b[0]));
  const tbody = document.querySelector('#table_det tbody');
  tbody.innerHTML = '';
  for(const [nome, v] of sorted){
    tbody.insertAdjacentHTML('beforeend', `<tr>
      <td>${nome}</td>
      <td>${v.qtd.toFixed(3)}</td>
      <td>${v.total.toFixed(2)}</td>
      <td>${v.lucro.toFixed(2)}</td>
    </tr>`);
  }
}

/* ---------- APAGAR HISTÓRICO ---------- */
async function apagarHist(){
  if(!confirm('Tem certeza de que quer APAGAR TODO o histórico de vendas?\nEsta ação não pode ser desfeita!')) return;
  await db.vendas.clear();
  await db.itensVenda.clear();
  alert('Histórico de vendas apagado com sucesso!');
  listarDiario(); listDet();
}

/* ---------- SERVICE WORKER (OFFLINE) ---------- */
if('serviceWorker' in navigator){
  const swCode = `
    self.addEventListener('install', e => {
      e.waitUntil(
        caches.open('mercearia-v1').then(cache => 
          cache.addAll([
            './',
            'https://unpkg.com/dexie@3.2.4/dist/dexie.min.js',
            'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js',
            'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js',
            'https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js'
          ])
        )
      );
    });
    self.addEventListener('fetch', e => {
      e.respondWith(
        caches.match(e.request).then(r => r || fetch(e.request))
      );
    });
  `;
  const blob = new Blob([swCode], {type: 'application/javascript'});
  const url = URL.createObjectURL(blob);
  navigator.serviceWorker.register(url);
}

/* ---------- INICIALIZA ---------- */
loadCats();
listProd();
</script>
</body>
</html>
